package com.arematics.minecraft.core.bukkit;

import com.arematics.minecraft.core.server.Server;
import com.comphenix.protocol.PacketType;
import com.comphenix.protocol.events.PacketEvent;
import org.bukkit.entity.Player;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

@Component
public class SlotClickExploitFixer extends ArematicsPacketAdapter {

    @Autowired
    public SlotClickExploitFixer(Server server) {
        super(server, PacketType.Play.Client.WINDOW_CLICK);
    }

    @Override
    protected void onReceive(final PacketEvent event) {
        Player player = event.getPlayer();
        Integer slot = event.getPacket().getIntegers().read(1);

        if (slot == -999 || slot == -1 || (slot >= 0 && slot <= 89)) return;

        event.setCancelled(true);

        server.schedule().runSync(() -> player.kickPlayer("You are sending wrong packets"));

        String message = TEAM_MESSAGE.replace("%name%", player.getName()).replace("%reason%",
                "Slot Exploit");
        server.getOnlineTeam().stream()
                .filter(result -> player.hasPermission("team.crashmessages"))
                .forEach(result -> result.info(message).handle());
        plugin.getLogger()
                .warning(player.getName() + " tried to exploit: Slot Exploit");
    }
}
