package com.arematics.minecraft.core.bukkit;

import com.arematics.minecraft.core.server.ArematicsComponent;
import com.arematics.minecraft.core.server.Server;
import com.comphenix.protocol.PacketType;
import com.comphenix.protocol.events.ListenerPriority;
import com.comphenix.protocol.events.PacketAdapter;
import com.comphenix.protocol.events.PacketEvent;
import org.bukkit.Bukkit;
import org.bukkit.entity.Player;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

@Component
public class SlotClickExploitFixer extends ArematicsComponent {
    private static final String teamMessage = "§6CustomPayload§8§l |§5Player %d§n%name%§5 has shown a §lvery§5 " +
            "strange behavior! Possibly wanted to crash the server! §6Reason: §o%reason% §eEventually watch and / or ban!";

    @Autowired
    public SlotClickExploitFixer(Server server) {
        super(server);
    }

    @Override
    public void load() {
        PacketAdapter packetListener = new PacketAdapter(plugin,
                ListenerPriority.HIGHEST, PacketType.Play.Client.WINDOW_CLICK) {
            @Override
            public void onPacketReceiving(PacketEvent event) {
                if(event.isCancelled()) return;

                long startTime = System.nanoTime();

                Player player = event.getPlayer();

                Integer slot = event.getPacket().getIntegers().read(1);

                if (slot <= 89) return;

                event.setCancelled(true);

                // #####################

                long stopTime = System.nanoTime();
                long took = stopTime - startTime;

                event.setCancelled(true);


                Bukkit.getScheduler().scheduleSyncDelayedTask(getPlugin(), () ->
                        player.kickPlayer("You are sending wrong packets"));

                String message = teamMessage.replace("%name%", player.getName()).replace("%reason%",
                        "Slot Exploit");
                server.getOnlineTeam().stream()
                        .filter(result -> player.hasPermission("team.crashmessages"))
                        .forEach(result -> result.info(message).handle());
                plugin.getLogger()
                        .warning(player.getName() + " tried to exploit: Slot Exploit");
            }
        };
        protocolManager.addPacketListener(packetListener);
    }
}
